#include <Arduino.h>
#include <ESP32Servo.h>
#include "BluetoothSerial.h" // Biblioteca nativa do ESP32 para Bluetooth

// Objeto Bluetooth
BluetoothSerial SerialBT;

// Servos
Servo motorCima;
Servo motorMola1;
Servo motorMola2;
Servo motorMola3;
Servo motorBaixo;

// Pinos dos servos
#define MOTOR_CIMA_PIN   27
#define MOTOR_MOLA1_PIN  13
#define MOTOR_MOLA2_PIN  12
#define MOTOR_MOLA3_PIN  14
#define MOTOR_BAIXO_PIN  26

// Estados possiveis
typedef enum {
  ESTADO_RELAXADO,
  PRESO_DISTENDIDO,
  SOBE_1,
  DESCE_1,
  PRESO_CONTRAIDO,
  SOBE_2,
  DESCE_2
} Estado;

// Estado atual
Estado estado = PRESO_DISTENDIDO;

// Variavel para saber se o ultimo movimento foi subida (true) ou descida (false)
bool ultimoSentidoFoiSubida = true; 

// Variavel global para memorizar a acao atual (inicia como 'p' de parado)
char acaoAtual = 'p'; 

const char* nomeEstado(Estado e) {
  switch (e) {
    case ESTADO_RELAXADO: return "ESTADO_RELAXADO";
    case PRESO_DISTENDIDO: return "PRESO_DISTENDIDO";
    case SOBE_1: return "SOBE_1";
    case DESCE_1: return "DESCE_1";
    case PRESO_CONTRAIDO: return "PRESO_CONTRAIDO";
    case SOBE_2: return "SOBE_2";
    case DESCE_2: return "DESCE_2";
    default: return "DESCONHECIDO";
  }
}

void setServoPosicao(Servo &servo, bool ativo) {
  if (ativo) servo.write(45);
  else servo.write(0);
}

// Move as 3 molas simultaneamente
void setServoContinuo(int v1, int v2, int v3, unsigned long duracao) {
  motorMola1.write(v1);
  motorMola2.write(v2);
  motorMola3.write(v3);
  
  // O robo fica bloqueado aqui enquanto se move
  delay(duracao); 
  
  motorMola1.write(90); 
  motorMola2.write(90);
  motorMola3.write(90);
}

void aplicaEstado(Estado e) {
  String msg = "Estado: " + String(nomeEstado(e));
  Serial.println(msg);
  SerialBT.println(msg);

  switch (e) {
    case ESTADO_RELAXADO:
      setServoPosicao(motorCima, false);
      setServoPosicao(motorBaixo, false);
      setServoContinuo(90, 90, 90, 0);
      break;

    case PRESO_DISTENDIDO:
      setServoPosicao(motorCima, true);
      setServoPosicao(motorBaixo, true);
      setServoContinuo(90, 90, 90, 100); 
      break;

    case SOBE_1:
      setServoPosicao(motorCima, true);
      setServoPosicao(motorBaixo, false);
      setServoContinuo(0, 0, 0, 2000); 
      break;

    case DESCE_1:
      setServoPosicao(motorCima, false);
      setServoPosicao(motorBaixo, true);
      setServoContinuo(0, 0, 0, 2000); 
      break;

    case PRESO_CONTRAIDO:
      setServoPosicao(motorCima, true);
      setServoPosicao(motorBaixo, true);
      setServoContinuo(90, 90, 90, 100);
      break;

    case SOBE_2:
      setServoPosicao(motorCima, false);
      setServoPosicao(motorBaixo, true);
      setServoContinuo(180, 180, 180, 2000);
      break;

    case DESCE_2:
      setServoPosicao(motorCima, true);
      setServoPosicao(motorBaixo, false);
      setServoContinuo(180, 180, 180, 2000);
      break;
  }
}

Estado pausaEstado(Estado e) {
  if (e == SOBE_1 || e == DESCE_1) return PRESO_CONTRAIDO;
  else if (e == SOBE_2 || e == DESCE_2) return PRESO_DISTENDIDO;
  else return e;
}

void verificarInversao(bool indoParaCima) {
  if (indoParaCima && !ultimoSentidoFoiSubida) {
    if (estado == DESCE_1) estado = PRESO_CONTRAIDO;
    else if (estado == DESCE_2) estado = PRESO_DISTENDIDO;
    aplicaEstado(estado);
  }
  else if (!indoParaCima && ultimoSentidoFoiSubida) {
    if (estado == SOBE_1) estado = PRESO_CONTRAIDO;
    else if (estado == SOBE_2) estado = PRESO_DISTENDIDO;
    aplicaEstado(estado);
  }
  ultimoSentidoFoiSubida = indoParaCima;
}

void setup() {
  Serial.begin(115200);
  SerialBT.begin("Robo_Cobra"); 
  Serial.println("Bluetooth iniciado! Use o Joystick.");

  motorCima.attach(MOTOR_CIMA_PIN);
  motorMola1.attach(MOTOR_MOLA1_PIN);
  motorMola2.attach(MOTOR_MOLA2_PIN);
  motorMola3.attach(MOTOR_MOLA3_PIN);
  motorBaixo.attach(MOTOR_BAIXO_PIN);

  aplicaEstado(estado);
}

void loop() {
  // 1. Leitura e Decodificacao dos Comandos do Joystick
  if (SerialBT.available()) {
    while (SerialBT.available()) {
      char c = SerialBT.read();
      
      if (c == 's') acaoAtual = 's';       // Apertou Cima -> Subir
      else if (c == '0') acaoAtual = 'p';  // Soltou Cima -> Pausar
      
      else if (c == 'd') acaoAtual = 'd';  // Apertou Baixo -> Descer
      else if (c == '1') acaoAtual = 'p';  // Soltou Baixo -> Pausar
      
      else if (c == 'a') acaoAtual = 'a';  // Apertou X -> Abortar
      else if (c == '2') acaoAtual = 'r';  // Soltou X -> Manter Relaxado
      
      else if (c == 'i') acaoAtual = 'i';  // Apertou 'i' -> Iniciar/Engatar
    }
  }

  // 2. Execucao baseada na acaoAtual memorizada
  
  if (acaoAtual == 's') { // SUBINDO
    verificarInversao(true); 
    if (estado == PRESO_DISTENDIDO) estado = SOBE_1;
    else if (estado == SOBE_1) estado = PRESO_CONTRAIDO;
    else if (estado == PRESO_CONTRAIDO) estado = SOBE_2;
    else if (estado == SOBE_2) estado = PRESO_DISTENDIDO;
    aplicaEstado(estado); 
  }
  
  else if (acaoAtual == 'd') { // DESCENDO
    verificarInversao(false); 
    if (estado == PRESO_DISTENDIDO) estado = DESCE_1;
    else if (estado == DESCE_1) estado = PRESO_CONTRAIDO;
    else if (estado == PRESO_CONTRAIDO) estado = DESCE_2;
    else if (estado == DESCE_2) estado = PRESO_DISTENDIDO;
    aplicaEstado(estado);
  }
  
  else if (acaoAtual == 'a') { // ABORTANDO
    // Executa a sequencia de abortar uma vez
    estado = pausaEstado(estado);
    aplicaEstado(estado);
    delay(2000);
    if (estado == PRESO_CONTRAIDO) {
        setServoContinuo(180, 180, 180, 2000);
    } 
    estado = ESTADO_RELAXADO;
    aplicaEstado(estado);
    
    // Apos abortar, muda automaticamente para 'r' (relaxado) para nao ficar repetindo o delay
    acaoAtual = 'r'; 
  }

  else if (acaoAtual == 'i') { // INICIAR (Engatar)
    if (estado == ESTADO_RELAXADO) {
        estado = PRESO_DISTENDIDO;
        aplicaEstado(estado);
    }
    // Depois de engatar, volta o comando para 'p' (pausa) para manter a posicao
    // e evitar reexecutar essa logica desnecessariamente
    acaoAtual = 'p';
  }
  
  else if (acaoAtual == 'p') { // PAUSA (Soltou o botao)
    Estado estadoPausa = pausaEstado(estado);
    if (estado != estadoPausa) {
      estado = estadoPausa;
      aplicaEstado(estado);
    }
    delay(50); 
  }
  
  else if (acaoAtual == 'r') { // RELAXADO (Botao X solto)
    // Garante que fique relaxado
    if (estado != ESTADO_RELAXADO) {
      estado = ESTADO_RELAXADO;
      aplicaEstado(estado);
    }
    delay(50);
  }
}
